# QM Benchmarks on optimized geometries

The benchmark scripts from Lim-Hahn's work (as mentioned in acknowledgment) as adapted in the Sage fitting repo, https://github.com/openforcefield/openff-sage/tree/main/inputs-and-results/benchmarks/qc-opt-geo, were used here. Additional slurmscripts are provided to run them on a HPC cluster, and the outputs were also attached. Some changes in the scripts include the application of an element filter to exclude {F, P, S, I} from the benchmark set (the QCArchive reference name for the benchmark set is `OpenFF Industry Benchmark Season 1 v1.1`). And, another change is the use of smirnoff-plugins for the new functional form, the forcefield loading call would include the `load_plugins` argument as in `smirnoff_force_field = smirnoff.ForceField(force_field_path, load_plugins=True, allow_cosmetic_attributes=True)`.


This directory contains the scripts needed to compute the ddE, RMSD, and TDF metrics for a set
of force fields against a QCArchive optimization data collection such as the `OpenFF Full Optimization Benchmark 1` 
QCArchive data set as was used in the [Lim and Hahn study](https://doi.org/10.26434/chemrxiv.12551867.v2) (see the 
Acknowledgments section below for more details).

## Running the benchmarks

* `01-setup.py`: Script to retrieve the relevant QC data from the QCArchive and filter out and incomplete or undesirable (e.g. records whereby the molecule connectivity changed during the QM minimization) records. The dataset to retrieve and benchmark against must be specified.
  - Input: Name of the dataset. For example, for the Lim and Hahn study:

   ```shell
   python 01-setup.py "OpenFF Full Optimization Benchmark 1"
   ```

   or for the Industrial partner benchmarks:

   ```shell
   python 01-setup.py "OpenFF Industry Benchmark Season 1 v1.1"
   ```
   - Output: The output this script generates is a SDF file, by default named as `01-processed-qm.sdf`, with all the final optimized geometries from the dataset specified. And, a json file with all the record ids, by default named as `01-processed-qm.json`.

* `02-a-chunk-qm.py`: Script to split the SDF file produced by `01-setup.py` into many smaller chunks. This allows the next step to be parallelized across many different CPUs / workers.
  - Input: The input path for the SDF file. Number of chunks to be split into (default=250). Output directory to store the chunks, defaults to `02-chunks`.
  - Output: A directory `02-chunks` with the n number of SDF files.

* `02-b-minimize.py`: To perform an MM energy minimization for each of the chunked files and for each force field of interest, and store the output.
  - Input: Structure file in SDF format. Force field name, or file path, to minimize the structures. Output directory and file name to store the MM minimized strctures to.
   ```shell
   python 02-b-minimize.py -ff openff-2.0.0.offxml \ 
                           -i 02-chunks/01-processed-qm-1.sdf \
                           -o 02-outputs/openff-2-0-0-1.sdf
   ```
  - Output: The MM minimized structures in SDF format and storing required information in SD data.

* `03-a-compute-metrics.py`: Using the MM minimized structures from step 2 compute the metrics RMSD/ddE/TFD.
  - Input: File path to the json file which contains information about the force field and the directories in which reference and MM minimized structures were stored. Output file path to store the metrics after calculation.
   ```shell
   python 03-a-compute-metrics.py --input "03-force-fields.json" --index 1 \
               --output 03-outputs/03-metrics-1.csv
   ```
  - Output: A CSV file listing out the molecules smiles and the various metrics like RMSD/TFD/ddE

* `03-b-join-metrics.py`: Concatenate the metrics files in csv format generated above 
  - Input: Path where the metrics files were stored (default is `03-outputs`)
   ```shell
   python 03-b-join-metrics.py 03-outputs/* -o 03-metrics.csv
   ```
  - Output: The combined CSV file.

* `04-plot-metrics.py`: Script to plot the metrics by reading the CSV file, which contains the data for each of the molecules and for each force field. 
  - Input: File path to the CSV file generated by `03-b-join-metrics.py`. Directory to store the outputs to (default is `04-outputs`).
  - Output: PNG files of the plots of RMSD/TFD/ddE which will be stored in `04-outputs`. There are many sub directories under `04-outputs`, the directory `04-outputs/full` corresponds to the metrics on the overall set, and the other directories are plots on subsets of R-groups named accordingly.

# File Manifest

- 01-processed-qm.json - File containing the exact optimization record ids used in this benchmark.
- 01-processed-qm.sdf.tar.gz - SDF file of the QM optimized final geometries for the corresponding records in the json file.
- 01-setup.py - Script to download and process the QM from QCArchive using `openff-qcsubmit`.
- 02-a-chunk-qm.py - Script to split the SDF file containing QM geometries into chunks for parallel MM optimizations.
- 02-b-minimize.py - Script to perform the MM minimizations with the QM geometry as as starting point
- 02-chunks.tar.gz - Compressed directory that contains the QM chunk files created.
- 02-outputs.tar.gz - Compressed directory that contains the MM optimizations of forcefields mentioned in `03-force-fields.json` file.
- 03-a-compute-metrics.py - Script to compute the metrics RMSD/TFD/ddE using the QM and MM optimized final geometries.
- 03-b-join-metrics.py - Script to combine the metrics from the chunks of csv files.
- 03-force-fields.json - File containing the force field and geometry file paths.
- 03-metrics.csv - Combined metrics file that contains RMSD/TFD/ddE data for all the conformers in the benchmark set.
- 03-outputs.tar.gz - Compressed directory that contains the metrics evaluated in csv files for respective chunks of data.
- 04-outputs.zip/ - Directory that contains only the aggregated plot outputs from the script `03-plot-metrics.py`.
- 04-plot-metrics.py - Script to plot the metrics RMSD/TFD/ddE on the whole dataset and on subsets of R-groups.


## Acknowledgments

The scripts in this directory are based off of those found in the `benchmarkff` repository
at commit hash [`6351878`](https://github.com/MobleyLab/benchmarkff/tree/6351878) which was produced 
by Victoria Lim under the following license:

    MIT License
    
    Copyright (c) 2019 Victoria Lim
    
    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:
    
    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.
    
    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.


